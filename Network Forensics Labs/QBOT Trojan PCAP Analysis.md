**In this demo, we will perform network forensics for following PCAP (BB12 QAKBOT (QBOT) WITH COBALT STRIKE AND DARK CAT VNC)**

You can download pcap.zip file fromÂ https://www.malware-traffic-analysis.net/2023/01/31/index.html

We will investigate the <a href="https://github.com/MyatKyawKaung/Snort/blob/main/Malware%20Traffic%20Analysis%20with%20Snort3.md#pcap_02-bb12-qakbot-qbot-with-cobalt-strike-and-dark-cat-vnc"> output file </a> generated from Snort alerts in Wireshark.

![image01](https://github.com/user-attachments/assets/54de235e-7da1-49ae-84fa-8226d1a5d796)

There are total of 56652 packets in this PCAP file. We can narrow down our analysis base on our Snort detected alerts

![image02](https://github.com/user-attachments/assets/d912c80e-3c0d-4792-99f7-704428e5d528)

### Identifying initial foothold

Many attacks use HTTP or HTTPS as part of the initial foothold (e.g., downloading malware or exploitation over the web) 

Use `http` filter to capture all http traffics which could indicate attempts to reach malicious URLs or to exploit a vulnerable web application.

![image03](https://github.com/user-attachments/assets/12c9ec5e-77f5-4b91-af9e-48758c901bdf)

We can identify this domain [http[:]//a[i]xjobsonline[.]net/SFAF[.]php?PPSIITERISAC=1](http://aixjobsonline.net/SFAF.php?PPSIITERISAC=1) as malicious after submitting to `VirusTotal`

![image04](https://github.com/user-attachments/assets/595dcac7-5450-4cf9-95f0-2b9c0b6ea89b)

This malicious domain hosted first-stage payload malware named `408709.one.zip` 

![image05](https://github.com/user-attachments/assets/022fcf63-bf50-43ef-93f6-2d6aafafa856)

Next, capture the start of secure connections (TLS handshakes) and HTTP traffic, but filtering out the noisy SSDP traffic often generated by network devices.

`(http.request or tls.handshake.type eq 1)`

We can also see the start of second-stage payload downloading connection as well

![image06](https://github.com/user-attachments/assets/f55a5c90-59bd-445e-95aa-861383d97fff)
![image07](https://github.com/user-attachments/assets/508fb2c7-5198-4779-af56-7af3dfae41b3)

Cobalt strike traffics can also be found from this IP 104[.]237[.]219[.]36 and Domain ciruvowuto[.]com

![image08](https://github.com/user-attachments/assets/5601f566-e3bc-4c8f-888b-6d8ae553bc79)
![image09](https://github.com/user-attachments/assets/95bf47b3-190e-4966-8d2e-c3e27176f825)
![image10](https://github.com/user-attachments/assets/7951e403-0e30-4bb1-8979-b25afc036301)


We identified IP address (52[.]191[.]219[.]104) from our previous Snort alerts which the malware downloaded and injected malicious DLLs.

![image11](https://github.com/user-attachments/assets/312f1085-a900-4a11-8182-a9f26acb1f17)
![image12](https://github.com/user-attachments/assets/3221093b-15dc-41ac-830e-fdaaa47ac9f0)

### Identifying C2 beaconing

`tcp.flags == 0x0002` Filters for TCP packets with only the SYN flag set (i.e., SYN packets with no ACK, FIN, etc.)

This filter is useful for identifying new TCP connection attempts (such as detecting potential port scans, connection establishment events, or other network behaviors involving TCP connections). </br> 
In this figure, you will see the infected host is making beaconing activities to its C2 servers.

![image13](https://github.com/user-attachments/assets/17866417-5322-4673-a659-28aa78c9dd43)

`tcp.port == 443 && tls.handshake.type == 1`
This filter captures **TLS Client Hello** packets over **HTTPS** (port 443), marking the start of secure connections. We can detect TLS based DGA traffics as well.

![image14](https://github.com/user-attachments/assets/6e08db40-2dcb-466d-86af-eac1c9232136)

Attacker hid C2 communication by blending C2 traffics in with legitimate domains as shown in figure
